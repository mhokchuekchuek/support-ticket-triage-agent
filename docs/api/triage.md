# Triage Endpoint

Analyzes a support ticket and returns triage recommendations.

## Location

`src/api/routes/triage.py`

## Endpoint

```
POST /api/triage
```

## Request

### Request Body

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| customer_id | string | Yes | Customer identifier |
| customer_info | CustomerInfo | No | Customer context (optional) |
| messages | TicketMessage[] | Yes | Conversation messages |
| metadata | object | No | Additional metadata |

> **Note**: `ticket_id` is auto-generated by the system or matched to an existing active ticket. `customer_info` is optional - if not provided, customer lookup will be attempted using `customer_id`.

### CustomerInfo Object

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| plan | string | Yes | Customer plan: free/pro/enterprise |
| tenure_months | integer | Yes | Months as customer |
| region | string | No | Customer region |
| seats | integer | No | Enterprise seat count |
| previous_tickets | integer | No | Previous ticket count (default: 0) |

### TicketMessage Object

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| role | string | Yes | Sender: 'customer' or 'agent' |
| content | string | Yes | Message text |
| timestamp | string | No | ISO 8601 timestamp |

### Example Request (Minimal)

```bash
curl -X POST http://localhost:8000/api/triage \
  -H "Content-Type: application/json" \
  -d '{
    "customer_id": "customer_001",
    "messages": [
      {
        "role": "customer",
        "content": "I was charged twice for my subscription!"
      }
    ]
  }'
```

### Example Request (Full)

```bash
curl -X POST http://localhost:8000/api/triage \
  -H "Content-Type: application/json" \
  -d '{
    "customer_id": "customer_001",
    "customer_info": {
      "plan": "enterprise",
      "tenure_months": 24,
      "region": "APAC",
      "seats": 45,
      "previous_tickets": 5
    },
    "messages": [
      {
        "role": "customer",
        "content": "System is down for 2 hours, 45 users affected!",
        "timestamp": "2024-11-15T14:00:00Z"
      }
    ]
  }'
```

## Response

### Response Body

| Field | Type | Description |
|-------|------|-------------|
| urgency | string | critical/high/medium/low |
| extracted_info | ExtractedInfo | Extracted ticket information |
| recommended_action | string | auto_respond/route_specialist/escalate_human |
| suggested_response | string | Suggested reply text (nullable) |
| relevant_articles | array | KB articles |
| reasoning | string | Explanation for triage decision |

### ExtractedInfo Object

| Field | Type | Description |
|-------|------|-------------|
| product_area | string | Affected product area (nullable) |
| issue_type | string | Type of issue |
| sentiment | string | Customer sentiment |
| language | string | Detected language |

### Example Response

```json
{
  "urgency": "critical",
  "extracted_info": {
    "product_area": "infrastructure",
    "issue_type": "outage",
    "sentiment": "urgent",
    "language": "en"
  },
  "recommended_action": "escalate_human",
  "suggested_response": null,
  "relevant_articles": [
    {
      "id": "kb_001",
      "title": "System Status Check",
      "relevance_score": 0.85
    }
  ],
  "reasoning": "Enterprise customer with 45 users experiencing system outage requires immediate escalation"
}
```

## Error Responses

| Status | Description |
|--------|-------------|
| 400 | Invalid request body |
| 500 | Triage processing failed |

## See Also

- [Ticket Entity](../src/entities/ticket.md)
- [TriageResult Entity](../src/entities/triage_result.md)
- [TriageService](../src/usecases/triage/README.md)
- [MultiAgentWorkflow](../src/modules/graph/workflow.md)
