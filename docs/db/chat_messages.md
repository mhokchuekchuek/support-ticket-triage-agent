# chat_messages Table

The `chat_messages` table stores conversation history for completed support tickets.

## Schema

```sql
CREATE TABLE IF NOT EXISTS chat_messages (
    ticket_id VARCHAR(255) NOT NULL,
    customer_id VARCHAR(255) NOT NULL,
    role VARCHAR(50) NOT NULL,
    content TEXT NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),

    PRIMARY KEY (ticket_id, created_at),

    CONSTRAINT chk_role CHECK (role IN ('human', 'ai', 'system'))
);
```

## Columns

| Column | Type | Nullable | Description |
|--------|------|----------|-------------|
| `ticket_id` | VARCHAR(255) | NO | Identifier for the support ticket |
| `customer_id` | VARCHAR(255) | NO | Customer who owns the ticket |
| `role` | VARCHAR(50) | NO | Message sender role (human/ai/system) |
| `content` | TEXT | NO | Message content |
| `created_at` | TIMESTAMP | NO | Message timestamp (part of PK) |

## Indexes

| Index Name | Column(s) | Purpose |
|------------|-----------|---------|
| `idx_chat_messages_customer_id` | `customer_id` | Find all messages by customer |
| `idx_chat_messages_ticket_id` | `ticket_id` | Find all messages for a ticket |

## Constraints

- **Primary Key**: Composite key of `(ticket_id, created_at)` - ensures unique messages per ticket ordered by time
- **Check Constraint**: `role` must be one of: `human`, `ai`, `system`

## Role Values

| Role | Description |
|------|-------------|
| `human` | Message from the customer |
| `ai` | Response generated by the AI agent |
| `system` | System-generated messages (e.g., status updates) |

## Usage

### Agent: TicketPersistenceAgent

The `TicketPersistenceAgent` writes messages to this table when a ticket is completed.

**File**: `src/modules/agents/ticket_persistence/main.py`

```python
for msg in messages:
    role = "human" if isinstance(msg, HumanMessage) else "ai"
    self.db_client.execute(
        """
        INSERT INTO chat_messages (ticket_id, customer_id, role, content, created_at)
        VALUES (%s, %s, %s, %s, %s)
        """,
        (ticket.ticket_id, ticket.customer_id, role, msg.content, datetime.utcnow())
    )
```

### Example Queries

```sql
-- Get all messages for a specific ticket
SELECT role, content, created_at
FROM chat_messages
WHERE ticket_id = 'TKT-12345678'
ORDER BY created_at ASC;

-- Get all conversations for a customer
SELECT ticket_id, role, content, created_at
FROM chat_messages
WHERE customer_id = 'cust_001'
ORDER BY ticket_id, created_at;

-- Count messages per ticket
SELECT ticket_id, COUNT(*) as message_count
FROM chat_messages
GROUP BY ticket_id;
```

## Data Lifecycle

1. **Active Ticket**: Messages stored in Redis checkpoints during workflow execution
2. **Ticket Completed**: `TicketPersistenceAgent` saves messages to PostgreSQL
3. **Cleanup**: Redis checkpoint data deleted after PostgreSQL save

## Notes

- Messages are ordered chronologically within each ticket using `created_at`
- No foreign key to a tickets table - chat_messages is standalone
- Customer context available through the `customers` table via `customer_id`
